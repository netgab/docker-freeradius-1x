#!/usr/bin/env bash

# Exit on error. Append "|| true" if you expect an error.
set -o errexit
# Exit on error inside any functions or subshells.
set -o errtrace
# Do not allow use of undefined vars. Use ${VAR:-} to use an undefined VAR
set -o nounset
# Catch the error in case mysqldump fails (but gzip succeeds) in `mysqldump |gzip`
set -o pipefail
# debugging
#set -x

__dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" # the full path of the directory where the script resides
__file="${__dir}/$(basename "${BASH_SOURCE[0]}")"     # full path including script name
__base="$(basename ${__file} .sh)"

function onExit() {
  echo "$(date) - exiting $__base"
  echo $?
}
trap onExit EXIT

## Basic variables and settings
# General variables
readonly FR1X_BASEDIR=/etc/rad1x
readonly FR1X_CONFDIR=$FR1X_BASEDIR/config
readonly FR1X_FILE_PROVISIONED=$FR1X_BASEDIR/.provisioned_1x

readonly FR1X_CADIR=$FR1X_BASEDIR/CA
readonly FR1X_CANAME="radius1X_demoCA"
readonly FR1X_CA_SUBJECT="CN=1X 802.1X Demo CA"
readonly FR1X_CA_OPENSSLCNF=$FR1X_CONFDIR/openssl/openssl.cnf
readonly FR1X_CA_RSA_KEYSIZE=4096
readonly FR1X_CA_VALIDITY_DAYS=3650     # 10 years
readonly FR1X_CA_PRIVKEY=$FR1X_CADIR/private/$FR1X_CANAME.key
readonly FR1X_CA_CERT=$FR1X_CADIR/$FR1X_CANAME.pem

# Environment variable names
readonly FR1X_ENV_CA_PRIVKEY_PASS=DOCKER_ENV_CA_PRIVKEY_PASS

# freeradius specific files or folders
FRAD_BASEDIR=/etc/raddb
FRAD_CONFIG_EAP=$FRAD_BASEDIR/mods-enabled/eap
FRAD_FILE_DH=$FRAD_BASEDIR/dh
FRAD_DIR_CERT=$FRAD_BASEDIR/certs

# Server certificate for EAP-TLS, TTLS and PEAP
readonly CERT_SERVER_RSA_KEYSIZE=4096
readonly CERT_SERVER_VALIDITY_DAYS=730
readonly CERT_SERVER_SUBJECT="/OU=Example certificate/CN=freeradius"
readonly CERT_SERVER_CERTFILE=$FRAD_DIR_CERT/server.pem
readonly CERT_SERVER_KEYFILE=$FRAD_DIR_CERT/server.key
readonly CERT_SERVER_CAFILE=$FRAD_DIR_CERT/ca.pem

## Begin script
# Check if this is a fresh installation

if [ ! -f $FR1X_FILE_PROVISIONED ]; then
    echo "Fresh installation detected (absence of file $FR1X_FILE_PROVISIONED)"
    echo "Start provisioning ..."
    if [ ! -d "$FR1X_BASEDIR" ]; then
      mkdir $FR1X_BASEDIR
    fi

    echo "Creating CA in $FR1X_CADIR ..."
    if [ ! -d "$FR1X_CADIR" ]; then
      mkdir $FR1X_CADIR
    fi
    mkdir $FR1X_CADIR/certs $FR1X_CADIR/private $FR1X_CADIR/crl
    # Create index file and initial serial number
    touch $FR1X_CADIR/index.txt
    echo '100001' >$FR1X_CADIR/serial
    # Create CRL file and initial serial number
    touch $FR1X_CADIR/crlnumber
    echo '100001' >$FR1X_CADIR/serial

    # Create CA certificate
    openssl req -config $FR1X_CA_OPENSSLCNF -new -passout env:$FR1X_ENV_CA_PRIVKEY_PASS -newkey rsa:$FR1X_CA_RSA_KEYSIZE -x509 \
      -keyout $FR1X_CA_PRIVKEY -out $FR1X_CA_CERT -days $FR1X_CA_VALIDITY_DAYS \
      -subj "/$FR1X_CA_SUBJECT" -extensions v3_ca

    # Create freeradius server certificate CSR and private key
    openssl req -config $FR1X_CA_OPENSSLCNF -nodes -newkey rsa:$CERT_SERVER_RSA_KEYSIZE \
      -keyout $CERT_SERVER_KEYFILE -out /tmp/server.csr -subj "$CERT_SERVER_SUBJECT"


    # Sign CSR
    openssl ca -config $FR1X_CA_OPENSSLCNF -policy policy_match \
      -out $CERT_SERVER_CERTFILE -in /tmp/server.csr -days $CERT_SERVER_VALIDITY_DAYS \
      -extensions [usr_ssl_client|usr_ssl_server|v3_ca] â€“sha256



fi






#openssl req -new -newkey rsa:2048 -days 730 -x509 -keyout /etc/raddb/certs/server.key -out /etc/raddb/certs/server.pem -passout pass:privkey -subj "/OU=Example certificate/CN=freeradius"

